<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒæœŸéŸ³æ¥½ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212;
            color: #E0E0E0;
        }
        .container {
            max-width: 900px;
        }
        .card {
            background-color: #1E1E1E;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }
        .btn-primary {
            background-color: #1DB954;
            color: white;
        }
        .btn-primary:hover {
            background-color: #168a3f;
        }
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: #424242;
            border-radius: 5px;
            outline: none;
            transition: opacity .2s;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #1DB954;
            border-radius: 50%;
            cursor: pointer;
        }
        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #1DB954;
            border-radius: 50%;
            cursor: pointer;
        }
        .text-gradient {
            background: linear-gradient(90deg, #1DB954, #1ed760);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex items-center justify-center min-h-screen p-4">

<!-- Console Section (Moved to the top to be visible on any screen) -->
<div class="fixed bottom-0 left-0 w-full card p-4 z-60">
    <h2 class="text-xl font-bold mb-2 text-green-300">ã‚³ãƒ³ã‚½ãƒ¼ãƒ«</h2>
    <div id="app-console" class="bg-gray-700 text-green-300 p-2 rounded-md h-32 overflow-y-scroll text-sm font-mono"></div>
</div>

<div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex flex-col items-center justify-center z-50">
    <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-green-500"></div>
    <p class="mt-4 text-white text-lg font-semibold">åˆæœŸåŒ–ä¸­...</p>
</div>

<div id="main-content" class="w-full max-w-2xl mx-auto flex flex-col items-center justify-center gap-6 p-6 card hidden">
    <h1 class="text-4xl sm:text-5xl font-extrabold text-center text-gradient mb-4">
        åŒæœŸéŸ³æ¥½ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼
    </h1>

    <!-- App ID and User ID Display -->
    <div class="w-full text-sm sm:text-base text-gray-400 font-mono flex flex-col sm:flex-row justify-between items-center bg-gray-800 p-3 rounded-lg">
        <div class="mb-2 sm:mb-0 sm:mr-4">ã‚¢ãƒ—ãƒªID: <span id="app-id"></span></div>
        <div>ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: <span id="user-id"></span></div>
    </div>

    <!-- Mode Selection -->
    <div id="mode-selection" class="w-full text-center flex flex-col sm:flex-row gap-4">
        <button id="host-btn" class="flex-1 py-3 px-6 rounded-lg font-bold text-lg bg-green-600 hover:bg-green-700 transition duration-300 ease-in-out shadow-lg">ãƒ›ã‚¹ãƒˆã¨ã—ã¦é–‹å§‹</button>
        <button id="join-btn" class="flex-1 py-3 px-6 rounded-lg font-bold text-lg bg-blue-600 hover:bg-blue-700 transition duration-300 ease-in-out shadow-lg">ãƒªã‚¹ãƒŠãƒ¼ã¨ã—ã¦å‚åŠ </button>
    </div>

    <!-- Content for Host -->
    <div id="host-content" class="w-full flex flex-col items-center hidden">
        <p class="text-center text-gray-400 mb-4">ã“ã®ãƒ‡ãƒã‚¤ã‚¹ãŒãƒ›ã‚¹ãƒˆã«ãªã‚Šã¾ã™ã€‚éŸ³æ¥½ã‚’å†ç”Ÿã—ã€ä»–ã®ãƒ‡ãƒã‚¤ã‚¹ã¨åŒæœŸã—ã¾ã™ã€‚</p>
        <div class="w-full mb-4 card p-6 flex flex-col gap-4">
            <h2 class="text-xl sm:text-2xl font-semibold mb-2 text-center">éŸ³æ¥½ã‚’é¸æŠ</h2>
            <div class="flex flex-col gap-2">
                <button class="bg-gray-700 hover:bg-gray-600 py-2 px-4 rounded transition duration-300" data-src="https://www.learningcontainer.com/wp-content/uploads/2020/02/Kalimba.mp3">Kalimba.mp3</button>
                <button class="bg-gray-700 hover:bg-gray-600 py-2 px-4 rounded transition duration-300" data-src="https://www.learningcontainer.com/wp-content/uploads/2020/02/Kalimba.mp3">åˆ¥ã®éŸ³æ¥½ï¼ˆãƒ‡ãƒ¢ç”¨ï¼‰</button>
            </div>
            <audio id="music-player" class="w-full mt-4 rounded-lg" controls></audio>
        </div>
    </div>

    <!-- Content for Listener -->
    <div id="listener-content" class="w-full flex flex-col items-center hidden">
        <p class="text-center text-gray-400 mb-4">ãƒ›ã‚¹ãƒˆã®å†ç”ŸçŠ¶æ…‹ã«åŒæœŸã—ã¾ã™ã€‚éŸ³æ¥½ã‚’å†ç”Ÿã™ã‚‹ã«ã¯ãƒ›ã‚¹ãƒˆãŒé–‹å§‹ã™ã‚‹ã¾ã§ãŠå¾…ã¡ãã ã•ã„ã€‚</p>
        <div class="w-full mb-4 card p-6 flex flex-col items-center">
            <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-center">ãƒ›ã‚¹ãƒˆã®éŸ³æ¥½ã‚’å†ç”Ÿä¸­</h2>
            <audio id="listener-player" class="w-full rounded-lg" controls></audio>
        </div>
    </div>
</div>

<!-- Custom Dialog Modal -->
<div id="dialog-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
    <div class="bg-gray-800 rounded-lg p-6 w-full max-w-sm card">
        <div class="flex flex-col items-center justify-center">
            <div id="dialog-icon" class="text-3xl mb-4"></div>
            <p id="dialog-message" class="text-center text-lg mb-4"></p>
            <button id="dialog-ok-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">OK</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Global variables for Firebase configuration. DO NOT modify these.
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    let firebaseConfig = {};
    try {
        if (typeof __firebase_config !== 'undefined' && __firebase_config) {
            firebaseConfig = JSON.parse(__firebase_config);
        } else {
            throw new Error('Firebase configuration variable not provided.');
        }
    } catch (e) {
        console.error('Failed to parse Firebase configuration:', e);
        firebaseConfig = {}; // Fallback to an empty object
    }
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // DOM Elements
    const loadingOverlay = document.getElementById('loading-overlay');
    const mainContent = document.getElementById('main-content');
    const appIdEl = document.getElementById('app-id');
    const userIdEl = document.getElementById('user-id');
    const modeSelection = document.getElementById('mode-selection');
    const hostBtn = document.getElementById('host-btn');
    const joinBtn = document.getElementById('join-btn');
    const hostContent = document.getElementById('host-content');
    const listenerContent = document.getElementById('listener-content');
    const musicPlayer = document.getElementById('music-player');
    const listenerPlayer = document.getElementById('listener-player');
    const musicButtons = document.querySelectorAll('#host-content button[data-src]');
    const dialogModal = document.getElementById('dialog-modal');
    const dialogMessage = document.getElementById('dialog-message');
    const dialogOkBtn = document.getElementById('dialog-ok-btn');
    const dialogIcon = document.getElementById('dialog-icon');
    const appConsole = document.getElementById('app-console');

    // State Variables
    let userId = null;
    let isHost = false;
    const syncThreshold = 0.5; // Sync if difference is more than 0.5 seconds

    // Function to add a log message to the console
    function log(message) {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement('div');
        logEntry.textContent = `[${timestamp}] ${message}`;
        appConsole.appendChild(logEntry);
        appConsole.scrollTop = appConsole.scrollHeight;
    }

    // Function to show custom dialog
    function showDialog(message, icon = 'ğŸµ') {
        dialogMessage.textContent = message;
        dialogIcon.textContent = icon;
        dialogModal.classList.remove('hidden');
    }

    // Function to hide custom dialog
    function hideDialog() {
        dialogModal.classList.add('hidden');
    }

    // Firebase Initialization
    let app, db, auth;
    try {
        if (!firebaseConfig.projectId) {
            throw new Error('"projectId" not provided in Firebase config.');
        }
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        log("Firebaseã®åˆæœŸåŒ–ã«æˆåŠŸã—ã¾ã—ãŸã€‚");

        // Auth State Listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                log('User signed in with UID: ' + userId);
                appIdEl.textContent = appId;
                userIdEl.textContent = userId;
            } else {
                log('No user signed in. Attempting anonymous sign-in...');
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        log('Signed in with custom token.');
                    } else {
                        await signInAnonymously(auth);
                        log('Signed in anonymously.');
                    }
                } catch (error) {
                    console.error("Authentication failed:", error);
                    log("èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
                    showDialog("èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚", "âš ï¸");
                }
            }
            // Always hide loading overlay and show content after the initial auth state check,
            // regardless of success or failure.
            loadingOverlay.classList.add('hidden');
            mainContent.classList.remove('hidden');
        });

    } catch (error) {
        console.error("Firebase initialization failed:", error);
        log("Firebaseã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
        showDialog("Firebaseã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚", "âš ï¸");
        loadingOverlay.classList.add('hidden');
        mainContent.classList.remove('hidden');
    }

    // Firestore Functions
    const getDocRef = (path) => doc(db, path);
    const getPublicDocRef = () => getDocRef(`/artifacts/${appId}/public/data/music-sync/host-state`);

    async function updateHostState(state) {
        if (!isHost) return;
        try {
            await setDoc(getPublicDocRef(), state);
            log("ãƒ›ã‚¹ãƒˆã®çŠ¶æ…‹ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚");
        } catch (e) {
            console.error("Error updating host state: ", e);
            log("ãƒ›ã‚¹ãƒˆã®çŠ¶æ…‹ã‚’æ›´æ–°ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚: " + e.message);
            showDialog("ãƒ›ã‚¹ãƒˆã®çŠ¶æ…‹ã‚’æ›´æ–°ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚", "âš ï¸");
        }
    }

    function listenForHostChanges() {
        log("ãƒ›ã‚¹ãƒˆã®å¤‰æ›´ã‚’ãƒªãƒƒã‚¹ãƒ³ã—ã¦ã„ã¾ã™...");
        onSnapshot(getPublicDocRef(), (doc) => {
            if (doc.exists() && !isHost) {
                const data = doc.data();
                log("ãƒ›ã‚¹ãƒˆã®çŠ¶æ…‹æ›´æ–°ã‚’å—ä¿¡ã—ã¾ã—ãŸã€‚");
                syncListener(data);
            }
        }, (error) => {
            console.error("Error listening for host changes:", error);
            log("åŒæœŸæƒ…å ±ã®å—ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚: " + error.message);
            showDialog("åŒæœŸæƒ…å ±ã®å—ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚", "âš ï¸");
        });
    }

    // Sync Logic
    function syncListener(state) {
        if (!state || !state.isPlaying) {
            listenerPlayer.pause();
            log("ãƒ›ã‚¹ãƒˆãŒå†ç”Ÿã‚’åœæ­¢ã—ã¾ã—ãŸã€‚");
            return;
        }

        const audioUrl = state.audioUrl;
        if (listenerPlayer.src !== audioUrl) {
            listenerPlayer.src = audioUrl;
            listenerPlayer.load();
            log("æ–°ã—ã„éŸ³æ¥½ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ: " + audioUrl);
        }
        
        // Only sync if a current time and timestamp are provided
        if (state.currentTime && state.timestamp) {
            const now = Date.now();
            const hostTimeAtUpdate = (state.currentTime + (now - state.timestamp) / 1000);
            const timeDifference = Math.abs(listenerPlayer.currentTime - hostTimeAtUpdate);

            if (timeDifference > syncThreshold) {
                listenerPlayer.currentTime = hostTimeAtUpdate;
                log(`æ™‚é–“ã‚’åŒæœŸã—ã¾ã—ãŸã€‚èª¤å·®: ${timeDifference.toFixed(2)}s.`);
            }
        }

        if (state.isPlaying) {
            listenerPlayer.play().catch(e => {
                console.error("Play failed:", e);
                log("å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸ: " + e.message);
            });
        } else {
            listenerPlayer.pause();
            log("ãƒ›ã‚¹ãƒˆãŒä¸€æ™‚åœæ­¢ã—ã¾ã—ãŸã€‚");
        }
    }

    // Event Listeners
    hostBtn.addEventListener('click', () => {
        isHost = true;
        modeSelection.classList.add('hidden');
        hostContent.classList.remove('hidden');
        musicPlayer.src = "https://www.learningcontainer.com/wp-content/uploads/2020/02/Kalimba.mp3"; // Default track
        showDialog("ã‚ãªãŸã¯ãƒ›ã‚¹ãƒˆã¨ã—ã¦é–‹å§‹ã—ã¾ã—ãŸã€‚éŸ³æ¥½ã‚’é¸æŠã—ã¦å†ç”Ÿã—ã¦ãã ã•ã„ã€‚", "ğŸ‘‘");
        log("ãƒ›ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚");
    });

    joinBtn.addEventListener('click', () => {
        isHost = false;
        modeSelection.classList.add('hidden');
        listenerContent.classList.remove('hidden');
        listenForHostChanges();
        showDialog("ã‚ãªãŸã¯ãƒªã‚¹ãƒŠãƒ¼ã¨ã—ã¦å‚åŠ ã—ã¾ã—ãŸã€‚ãƒ›ã‚¹ãƒˆã®éŸ³æ¥½ã‚’å¾…ã¡ã¾ã™ã€‚", "ğŸ§");
        log("ãƒªã‚¹ãƒŠãƒ¼ãƒ¢ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚");
    });

    musicButtons.forEach(button => {
        button.addEventListener('click', () => {
            const audioSrc = button.getAttribute('data-src');
            musicPlayer.src = audioSrc;
            musicPlayer.play();
            updateHostState({
                isPlaying: true,
                currentTime: musicPlayer.currentTime,
                audioUrl: audioSrc,
                timestamp: Date.now()
            });
            log("éŸ³æ¥½ã®é¸æŠã¨å†ç”Ÿã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚");
        });
    });

    musicPlayer.addEventListener('play', () => {
        if (isHost) {
            updateHostState({
                isPlaying: true,
                currentTime: musicPlayer.currentTime,
                audioUrl: musicPlayer.src,
                timestamp: Date.now()
            });
            log("ãƒ›ã‚¹ãƒˆãŒå†ç”Ÿã—ã¾ã—ãŸã€‚");
        }
    });

    musicPlayer.addEventListener('pause', () => {
        if (isHost) {
            updateHostState({
                isPlaying: false,
                currentTime: musicPlayer.currentTime,
                audioUrl: musicPlayer.src,
                timestamp: Date.now()
            });
            log("ãƒ›ã‚¹ãƒˆãŒä¸€æ™‚åœæ­¢ã—ã¾ã—ãŸã€‚");
        }
    });

    musicPlayer.addEventListener('seeked', () => {
        if (isHost) {
            updateHostState({
                isPlaying: musicPlayer.paused ? false : true,
                currentTime: musicPlayer.currentTime,
                audioUrl: musicPlayer.src,
                timestamp: Date.now()
            });
            log("ãƒ›ã‚¹ãƒˆãŒã‚·ãƒ¼ã‚¯ã—ã¾ã—ãŸã€‚");
        }
    });

    // Periodically update host's timestamp to keep it fresh
    setInterval(() => {
        if (isHost && !musicPlayer.paused) {
            updateHostState({
                isPlaying: true,
                currentTime: musicPlayer.currentTime,
                audioUrl: musicPlayer.src,
                timestamp: Date.now()
            });
        }
    }, 2000); // Update every 2 seconds

    dialogOkBtn.addEventListener('click', hideDialog);

</script>
</body>
</html>
