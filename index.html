<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>同期音楽プレーヤー</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212;
            color: #E0E0E0;
        }
        .container {
            max-width: 900px;
        }
        .card {
            background-color: #1E1E1E;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }
        .btn-primary {
            background-color: #1DB954;
            color: white;
        }
        .btn-primary:hover {
            background-color: #168a3f;
        }
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: #424242;
            border-radius: 5px;
            outline: none;
            transition: opacity .2s;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #1DB954;
            border-radius: 50%;
            cursor: pointer;
        }
        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #1DB954;
            border-radius: 50%;
            cursor: pointer;
        }
        .text-gradient {
            background: linear-gradient(90deg, #1DB954, #1ed760);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex items-center justify-center min-h-screen p-4">

<div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex flex-col items-center justify-center z-50">
    <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-green-500"></div>
    <p class="mt-4 text-white text-lg font-semibold">初期化中...</p>
</div>

<div id="main-content" class="w-full max-w-2xl mx-auto flex flex-col items-center justify-center gap-6 p-6 card hidden">
    <h1 class="text-4xl sm:text-5xl font-extrabold text-center text-gradient mb-4">
        同期音楽プレーヤー
    </h1>

    <!-- App ID and User ID Display -->
    <div class="w-full text-sm sm:text-base text-gray-400 font-mono flex flex-col sm:flex-row justify-between items-center bg-gray-800 p-3 rounded-lg">
        <div class="mb-2 sm:mb-0 sm:mr-4">アプリID: <span id="app-id"></span></div>
        <div>ユーザーID: <span id="user-id"></span></div>
    </div>

    <!-- Mode Selection -->
    <div id="mode-selection" class="w-full text-center flex flex-col sm:flex-row gap-4">
        <button id="host-btn" class="flex-1 py-3 px-6 rounded-lg font-bold text-lg bg-green-600 hover:bg-green-700 transition duration-300 ease-in-out shadow-lg">ホストとして開始</button>
        <button id="join-btn" class="flex-1 py-3 px-6 rounded-lg font-bold text-lg bg-blue-600 hover:bg-blue-700 transition duration-300 ease-in-out shadow-lg">リスナーとして参加</button>
    </div>

    <!-- Content for Host -->
    <div id="host-content" class="w-full flex flex-col items-center hidden">
        <p class="text-center text-gray-400 mb-4">このデバイスがホストになります。音楽を再生し、他のデバイスと同期します。</p>
        <div class="w-full mb-4 card p-6 flex flex-col gap-4">
            <h2 class="text-xl sm:text-2xl font-semibold mb-2 text-center">音楽を選択</h2>
            <div class="flex flex-col gap-2">
                <button class="bg-gray-700 hover:bg-gray-600 py-2 px-4 rounded transition duration-300" data-src="https://www.learningcontainer.com/wp-content/uploads/2020/02/Kalimba.mp3">Kalimba.mp3</button>
                <button class="bg-gray-700 hover:bg-gray-600 py-2 px-4 rounded transition duration-300" data-src="https://www.learningcontainer.com/wp-content/uploads/2020/02/Kalimba.mp3">別の音楽（デモ用）</button>
            </div>
            <audio id="music-player" class="w-full mt-4 rounded-lg" controls></audio>
        </div>
    </div>

    <!-- Content for Listener -->
    <div id="listener-content" class="w-full flex flex-col items-center hidden">
        <p class="text-center text-gray-400 mb-4">ホストの再生状態に同期します。音楽を再生するにはホストが開始するまでお待ちください。</p>
        <div class="w-full mb-4 card p-6 flex flex-col items-center">
            <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-center">ホストの音楽を再生中</h2>
            <audio id="listener-player" class="w-full rounded-lg" controls></audio>
        </div>
    </div>
</div>

<!-- Custom Dialog Modal -->
<div id="dialog-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
    <div class="bg-gray-800 rounded-lg p-6 w-full max-w-sm card">
        <div class="flex flex-col items-center justify-center">
            <div id="dialog-icon" class="text-3xl mb-4"></div>
            <p id="dialog-message" class="text-center text-lg mb-4"></p>
            <button id="dialog-ok-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">OK</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Global variables for Firebase configuration. DO NOT modify these.
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // Firebase Initialization
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // DOM Elements
    const loadingOverlay = document.getElementById('loading-overlay');
    const mainContent = document.getElementById('main-content');
    const appIdEl = document.getElementById('app-id');
    const userIdEl = document.getElementById('user-id');
    const modeSelection = document.getElementById('mode-selection');
    const hostBtn = document.getElementById('host-btn');
    const joinBtn = document.getElementById('join-btn');
    const hostContent = document.getElementById('host-content');
    const listenerContent = document.getElementById('listener-content');
    const musicPlayer = document.getElementById('music-player');
    const listenerPlayer = document.getElementById('listener-player');
    const musicButtons = document.querySelectorAll('#host-content button[data-src]');
    const dialogModal = document.getElementById('dialog-modal');
    const dialogMessage = document.getElementById('dialog-message');
    const dialogOkBtn = document.getElementById('dialog-ok-btn');
    const dialogIcon = document.getElementById('dialog-icon');

    // State Variables
    let userId = null;
    let isHost = false;
    let isInitialized = false;
    const syncThreshold = 0.5; // Sync if difference is more than 0.5 seconds

    // Function to show custom dialog
    function showDialog(message, icon = '🎵') {
        dialogMessage.textContent = message;
        dialogIcon.textContent = icon;
        dialogModal.classList.remove('hidden');
    }

    // Function to hide custom dialog
    function hideDialog() {
        dialogModal.classList.add('hidden');
    }
    
    // Auth State Listener
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            userId = user.uid;
            console.log('User signed in with UID:', userId);
            appIdEl.textContent = appId;
            userIdEl.textContent = userId;
            loadingOverlay.classList.add('hidden');
            mainContent.classList.remove('hidden');
            isInitialized = true;
        } else {
            console.log('No user signed in. Signing in anonymously...');
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                showDialog("認証に失敗しました。ページをリロードしてください。", "⚠️");
            }
        }
    });

    // Firestore Functions
    const getDocRef = (path) => doc(db, path);
    const getPublicDocRef = () => getDocRef(`/artifacts/${appId}/public/data/music-sync/host-state`);

    async function updateHostState(state) {
        if (!isHost) return;
        try {
            await setDoc(getPublicDocRef(), state);
            console.log("Host state updated:", state);
        } catch (e) {
            console.error("Error updating host state: ", e);
            showDialog("ホストの状態を更新できませんでした。ネットワーク接続を確認してください。", "⚠️");
        }
    }

    function listenForHostChanges() {
        console.log("Listening for host changes...");
        onSnapshot(getPublicDocRef(), (doc) => {
            if (doc.exists() && !isHost) {
                const data = doc.data();
                console.log("Received host state update:", data);
                syncListener(data);
            }
        }, (error) => {
            console.error("Error listening for host changes:", error);
            showDialog("同期情報の受信に失敗しました。ネットワーク接続を確認してください。", "⚠️");
        });
    }

    // Sync Logic
    function syncListener(state) {
        if (!state || !state.isPlaying || !state.currentTime) {
            listenerPlayer.pause();
            return;
        }

        const audioUrl = state.audioUrl || "https://www.learningcontainer.com/wp-content/uploads/2020/02/Kalimba.mp3";
        if (listenerPlayer.src !== audioUrl) {
            listenerPlayer.src = audioUrl;
            listenerPlayer.load();
        }
        
        const now = Date.now();
        const hostTimeAtUpdate = (state.currentTime + (now - state.timestamp) / 1000);
        const timeDifference = Math.abs(listenerPlayer.currentTime - hostTimeAtUpdate);

        if (timeDifference > syncThreshold) {
            listenerPlayer.currentTime = hostTimeAtUpdate;
            console.log(`Synced listener time. Difference was ${timeDifference.toFixed(2)}s.`);
        }

        if (state.isPlaying) {
            listenerPlayer.play().catch(e => console.error("Play failed:", e));
        } else {
            listenerPlayer.pause();
        }
    }

    // Event Listeners
    hostBtn.addEventListener('click', () => {
        isHost = true;
        modeSelection.classList.add('hidden');
        hostContent.classList.remove('hidden');
        musicPlayer.src = "https://www.learningcontainer.com/wp-content/uploads/2020/02/Kalimba.mp3"; // Default track
        showDialog("あなたはホストとして開始しました。音楽を選択して再生してください。", "👑");
    });

    joinBtn.addEventListener('click', () => {
        isHost = false;
        modeSelection.classList.add('hidden');
        listenerContent.classList.remove('hidden');
        listenForHostChanges();
        showDialog("あなたはリスナーとして参加しました。ホストの音楽を待ちます。", "🎧");
    });

    musicButtons.forEach(button => {
        button.addEventListener('click', () => {
            const audioSrc = button.getAttribute('data-src');
            musicPlayer.src = audioSrc;
            musicPlayer.play();
            updateHostState({
                isPlaying: true,
                currentTime: musicPlayer.currentTime,
                audioUrl: audioSrc,
                timestamp: Date.now()
            });
        });
    });

    musicPlayer.addEventListener('play', () => {
        if (isHost) {
            updateHostState({
                isPlaying: true,
                currentTime: musicPlayer.currentTime,
                audioUrl: musicPlayer.src,
                timestamp: Date.now()
            });
        }
    });

    musicPlayer.addEventListener('pause', () => {
        if (isHost) {
            updateHostState({
                isPlaying: false,
                currentTime: musicPlayer.currentTime,
                audioUrl: musicPlayer.src,
                timestamp: Date.now()
            });
        }
    });

    musicPlayer.addEventListener('seeked', () => {
        if (isHost) {
            updateHostState({
                isPlaying: musicPlayer.paused ? false : true,
                currentTime: musicPlayer.currentTime,
                audioUrl: musicPlayer.src,
                timestamp: Date.now()
            });
        }
    });

    // Periodically update host's timestamp to keep it fresh
    setInterval(() => {
        if (isHost && !musicPlayer.paused) {
            updateHostState({
                isPlaying: true,
                currentTime: musicPlayer.currentTime,
                audioUrl: musicPlayer.src,
                timestamp: Date.now()
            });
        }
    }, 2000); // Update every 2 seconds

    dialogOkBtn.addEventListener('click', hideDialog);

</script>
</body>
</html>
