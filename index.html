<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC 音楽同期 (サーバーレス)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #1f2937;
        }
        .container {
            max-width: 800px;
            width: 100%;
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            margin: 1rem;
        }
        .file-input-label {
            display: block;
            background-color: #6366f1;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .file-input-label:hover {
            background-color: #4f46e5;
        }
        textarea {
            resize: none;
            height: 150px;
        }
    </style>
</head>
<body class="bg-gray-100">

<div class="container space-y-8">
    <h1 class="text-4xl font-bold text-center text-indigo-700">WebRTC 音楽同期</h1>
    <p class="text-center text-gray-600">
        サーバーなしで友達と音楽を同時に聴きましょう。QRコードを使って接続を確立できます。
    </p>

    <!-- 接続設定セクション -->
    <div id="setup-section" class="space-y-6">
        <!-- ホストの手順 -->
        <div id="host-guide" class="space-y-4 p-6 border-2 border-indigo-200 rounded-xl">
            <h2 class="text-2xl font-bold text-indigo-600">ホストの手順</h2>
            <ol class="list-decimal list-inside space-y-2 text-gray-700">
                <li><button id="create-offer-button" class="bg-indigo-500 text-white font-bold py-2 px-4 rounded-full shadow-lg hover:bg-indigo-600 transition-colors">接続情報を生成</button>すると、QRコードが表示されます。</li>
                <li>友達にそのQRコードをスキャンしてもらいます。</li>
                <li>友達から送られてきた情報を下の**ゲストからの情報**に貼り付け、「接続開始」ボタンを押します。</li>
            </ol>
            <div class="space-y-4">
                <h3 class="font-bold text-lg">ホストの情報（生成された情報）</h3>
                <div id="offer-qrcode" class="w-48 h-48 mx-auto my-4"></div>
                <textarea id="offer-textarea" readonly class="w-full p-2 border border-gray-300 rounded-lg bg-gray-50 focus:outline-none"></textarea>
                <button id="copy-offer-button" class="w-full bg-indigo-100 text-indigo-700 font-medium py-2 px-4 rounded-full hover:bg-indigo-200 transition-colors">テキストをコピー</button>
            </div>
            <div class="space-y-4">
                <h3 class="font-bold text-lg">ゲストからの情報（入力）</h3>
                <textarea id="answer-input" class="w-full p-2 border border-gray-300 rounded-lg bg-white focus:outline-none"></textarea>
                <button id="connect-host-button" class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded-full shadow-md hover:bg-green-600 transition-colors">接続開始</button>
            </div>
        </div>
        
        <!-- ゲストの手順 -->
        <div id="guest-guide" class="space-y-4 p-6 border-2 border-green-200 rounded-xl">
            <h2 class="text-2xl font-bold text-green-600">ゲストの手順</h2>
            <ol class="list-decimal list-inside space-y-2 text-gray-700">
                <li>ホストのQRコードをスキャンして下の**ホストからの情報**に情報を貼り付けます。</li>
                <li><button id="create-answer-button" class="bg-green-500 text-white font-bold py-2 px-4 rounded-full shadow-lg hover:bg-green-600 transition-colors">接続情報を生成</button>すると、QRコードが表示されます。</li>
                <li>そのQRコードをホストにスキャンしてもらいます。</li>
            </ol>
            <div class="space-y-4">
                <h3 class="font-bold text-lg">ホストからの情報（入力）</h3>
                <textarea id="offer-input" class="w-full p-2 border border-gray-300 rounded-lg bg-white focus:outline-none"></textarea>
            </div>
            <div class="space-y-4">
                <h3 class="font-bold text-lg">ゲストの情報（生成された情報）</h3>
                <div id="answer-qrcode" class="w-48 h-48 mx-auto my-4"></div>
                <textarea id="answer-textarea" readonly class="w-full p-2 border border-gray-300 rounded-lg bg-gray-50 focus:outline-none"></textarea>
                <button id="copy-answer-button" class="w-full bg-green-100 text-green-700 font-medium py-2 px-4 rounded-full hover:bg-green-200 transition-colors">テキストをコピー</button>
            </div>
            <div class="space-y-4">
                <button id="go-to-player-button" class="w-full bg-indigo-500 text-white font-bold py-2 px-4 rounded-full shadow-md hover:bg-indigo-600 transition-colors hidden">再生画面へ進む</button>
            </div>
        </div>
    </div>
    
    <!-- 音楽再生セクション -->
    <div id="music-section" class="hidden space-y-4">
        <div id="host-controls" class="hidden space-y-4">
            <input type="file" id="audio-file-input" accept="audio/*" class="hidden">
            <label for="audio-file-input" class="file-input-label">
                音楽ファイルを選択
            </label>
        </div>
        <div id="guest-status" class="hidden text-center text-gray-500">
            音楽の再生をホストが開始するのを待っています...
        </div>
        <audio id="player" controls class="w-full"></audio>
    </div>

    <!-- メッセージボックス -->
    <div id="message-box" class="fixed bottom-4 right-4 p-4 bg-gray-800 text-white rounded-lg shadow-xl hidden"></div>
</div>

<script>
    // UI要素の取得
    const setupSection = document.getElementById('setup-section');
    const musicSection = document.getElementById('music-section');
    const createOfferButton = document.getElementById('create-offer-button');
    const createAnswerButton = document.getElementById('create-answer-button');
    const connectHostButton = document.getElementById('connect-host-button');
    const goToPlayerButton = document.getElementById('go-to-player-button');
    const offerTextarea = document.getElementById('offer-textarea');
    const answerInput = document.getElementById('answer-input');
    const offerInput = document.getElementById('offer-input');
    const answerTextarea = document.getElementById('answer-textarea');
    const copyOfferButton = document.getElementById('copy-offer-button');
    const copyAnswerButton = document.getElementById('copy-answer-button');
    const audioFileInput = document.getElementById('audio-file-input');
    const player = document.getElementById('player');
    const hostControls = document.getElementById('host-controls');
    const guestStatus = document.getElementById('guest-status');
    const messageBox = document.getElementById('message-box');
    const offerQrcodeDiv = document.getElementById('offer-qrcode');
    const answerQrcodeDiv = document.getElementById('answer-qrcode');

    // WebRTC関連のグローバル変数
    let peerConnection;
    let dataChannel;
    let isHost = false;

    // メッセージボックスを表示するヘルパー関数
    function showMessage(message, type = 'info') {
        messageBox.textContent = message;
        messageBox.style.backgroundColor = type === 'error' ? '#dc2626' : '#1f2937';
        messageBox.classList.remove('hidden');
        setTimeout(() => {
            messageBox.classList.add('hidden');
        }, 5000);
    }
    
    // クリップボードにテキストをコピーする関数
    function copyToClipboard(text, successMessage) {
        const tempInput = document.createElement('textarea');
        tempInput.value = text;
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand('copy');
        document.body.removeChild(tempInput);
        showMessage(successMessage, 'success');
    }

    // RTC Peer Connectionのセットアップ
    function setupPeerConnection() {
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' }
            ]
        };
        peerConnection = new RTCPeerConnection(configuration);

        // ICE candidateを収集
        peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
                if (isHost) {
                    const signalingData = JSON.parse(offerTextarea.value || '{}');
                    signalingData.candidates = signalingData.candidates || [];
                    signalingData.candidates.push(event.candidate.toJSON());
                    const jsonStr = JSON.stringify(signalingData);
                    offerTextarea.value = jsonStr;
                    generateQRCode(offerQrcodeDiv, jsonStr);
                } else {
                    const signalingData = JSON.parse(answerTextarea.value || '{}');
                    signalingData.candidates = signalingData.candidates || [];
                    signalingData.candidates.push(event.candidate.toJSON());
                    const jsonStr = JSON.stringify(signalingData);
                    answerTextarea.value = jsonStr;
                    generateQRCode(answerQrcodeDiv, jsonStr);
                    goToPlayerButton.classList.remove('hidden');
                }
            }
        };

        // リモートトラックを受信
        peerConnection.ontrack = (event) => {
            player.srcObject = event.streams[0];
            
            // ゲスト側でUIを切り替える
            musicSection.classList.remove('hidden');
            guestStatus.classList.add('hidden');
            setupSection.classList.add('hidden');

            player.play();
        };

        // データチャンネルの接続を待機
        peerConnection.ondatachannel = (event) => {
            dataChannel = event.channel;
            dataChannel.onopen = () => showMessage("データチャンネルが接続されました！", 'success');
            dataChannel.onmessage = handleDataChannelMessage;
        };
    }

    // QRコードを生成する関数
    function generateQRCode(element, text) {
        element.innerHTML = ''; // 古いQRコードをクリア
        new QRCode(element, {
            text: text,
            width: 192,
            height: 192,
            colorDark : "#1f2937",
            colorLight : "#f3f4f6",
            correctLevel : QRCode.CorrectLevel.H
        });
    }
    
    // データチャンネル経由で受け取ったメッセージを処理
    function handleDataChannelMessage(event) {
        try {
            const message = JSON.parse(event.data);
            if (message.type === 'play') {
                player.currentTime = message.time;
                player.play();
            } else if (message.type === 'pause') {
                player.currentTime = message.time;
                player.pause();
            } else if (message.type === 'stop') {
                player.currentTime = 0;
                player.pause();
            }
        } catch (error) {
            console.error("データチャンネルメッセージの解析に失敗しました:", error);
        }
    }

    // ホストの接続情報を生成
    createOfferButton.onclick = async () => {
        isHost = true;
        setupPeerConnection();

        // データチャンネルの作成（ホストのみ）
        dataChannel = peerConnection.createDataChannel("chat");
        dataChannel.onopen = () => showMessage("データチャンネルが接続されました！", 'success');
        dataChannel.onmessage = handleDataChannelMessage;

        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        
        const signalingData = {
            sdp: peerConnection.localDescription.sdp,
            type: peerConnection.localDescription.type,
            candidates: []
        };
        const jsonStr = JSON.stringify(signalingData);
        offerTextarea.value = jsonStr;
        generateQRCode(offerQrcodeDiv, jsonStr);
        showMessage("接続情報が生成されました。QRコードをスキャンしてください。", "info");
    };

    // ゲストの接続情報を生成
    createAnswerButton.onclick = async () => {
        isHost = false;
        if (!offerInput.value.trim()) {
            showMessage("ホストの接続情報をテキストボックスに貼り付けてください。", 'error');
            return;
        }

        let offer;
        try {
            offer = JSON.parse(offerInput.value);
        } catch (e) {
            showMessage("無効なJSON形式です。正しい情報を貼り付けてください。", 'error');
            return;
        }

        if (!offer.sdp) {
            showMessage("有効な接続情報が貼り付けられていません。", 'error');
            return;
        }

        setupPeerConnection();
        await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        
        const signalingData = {
            sdp: peerConnection.localDescription.sdp,
            type: peerConnection.localDescription.type,
            candidates: []
        };
        const jsonStr = JSON.stringify(signalingData);
        answerTextarea.value = jsonStr;
        generateQRCode(answerQrcodeDiv, jsonStr);
        
        // ホストから送られてきたICE候補を追加
        if (offer.candidates) {
            for (const candidate of offer.candidates) {
                await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
            }
        }
        showMessage("回答が生成されました。QRコードをホストにスキャンさせてください。", "info");
    };
    
    // ホストがゲストの接続情報を受け取って接続を開始
    connectHostButton.onclick = async () => {
        if (!peerConnection || peerConnection.signalingState !== 'have-local-offer') {
            showMessage("まず、'接続情報を生成'ボタンを押して、ホストとしての接続を初期化してください。", "error");
            return;
        }

        if (!answerInput.value.trim()) {
            showMessage("ゲストの接続情報をテキストボックスに貼り付けてください。", 'error');
            return;
        }

        let answer;
        try {
            answer = JSON.parse(answerInput.value);
        } catch (e) {
            showMessage("無効なJSON形式です。正しい情報を貼り付けてください。", 'error');
            return;
        }

        if (!answer.sdp) {
            showMessage("有効な接続情報が貼り付けられていません。", 'error');
            return;
        }
        await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));

        // ゲストから送られてきたICE候補を追加
        if (answer.candidates) {
            for (const candidate of answer.candidates) {
                await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
            }
        }
        
        hostControls.classList.remove('hidden');
        setupSection.classList.add('hidden');
        musicSection.classList.remove('hidden');
        showMessage("接続が確立しました！", 'success');
    };
    
    // ゲストが再生画面に移動
    goToPlayerButton.onclick = () => {
        setupSection.classList.add('hidden');
        musicSection.classList.remove('hidden');
        guestStatus.classList.remove('hidden');
    }

    // ホストが音楽ファイルを読み込む
    audioFileInput.onchange = (event) => {
        const file = event.target.files[0];
        if (file) {
            const fileUrl = URL.createObjectURL(file);
            player.src = fileUrl;
            
            // WebRTCストリームとして送信
            const mediaStream = player.captureStream();
            mediaStream.getTracks().forEach(track => peerConnection.addTrack(track, mediaStream));

            showMessage('音楽ファイルがロードされました。再生・一時停止は自動で同期されます。', 'success');
        }
    };

    // 再生・一時停止の同期
    player.onplay = () => {
        if (isHost && dataChannel && dataChannel.readyState === 'open') {
            dataChannel.send(JSON.stringify({ type: 'play', time: player.currentTime }));
        }
    };

    player.onpause = () => {
        if (isHost && dataChannel && dataChannel.readyState === 'open') {
            dataChannel.send(JSON.stringify({ type: 'pause', time: player.currentTime }));
        }
    };

    // コピーボタンのイベントリスナー
    copyOfferButton.onclick = () => copyToClipboard(offerTextarea.value, "接続情報をコピーしました！");
    copyAnswerButton.onclick = () => copyToClipboard(answerTextarea.value, "接続情報をコピーしました！");

</script>
</body>
</html>
