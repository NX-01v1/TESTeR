<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Music Sync</title>
    <!-- Tailwind CSSをCDNで読み込み -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- QRコード生成ライブラリ -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    <!-- html5-qrcodeライブラリを使用 -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            color: #334155;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 2rem;
        }
        .container {
            background-color: white;
            padding: 2.5rem;
            border-radius: 2rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            width: 100%;
        }
        .file-input-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            border: 2px dashed #9ca3af;
            border-radius: 1rem;
            color: #6b7280;
            cursor: pointer;
            transition: border-color 0.2s, background-color 0.2s;
        }
        .file-input-label:hover {
            border-color: #4f46e5;
            background-color: #eef2ff;
        }
        #fileInput {
            display: none;
        }
        #qrCodeHost, #qrCodeClient {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 1rem;
        }
        /* スキャナーのビデオ要素のスタイル */
        #qr-reader-host__dashboard_section,
        #qr-reader-client__dashboard_section {
            padding: 0;
        }
        .code-box {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 1rem;
            border-radius: 0.5rem;
            word-break: break-all;
            white-space: pre-wrap;
            position: relative;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="container space-y-6">
        <h1 class="text-3xl font-bold text-center text-indigo-700">WebRTC Music Sync</h1>
        <p class="text-center text-gray-600">
            みんなで音楽を同期して聴こう！
        </p>

        <!-- ロール選択セクション -->
        <div id="roleSelection" class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
            <button id="startHostButton" class="flex-1 px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition">ホストとして始める</button>
            <button id="startClientButton" class="flex-1 px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition">参加者として参加</button>
        </div>

        <!-- メインアプリセクション (最初は非表示) -->
        <div id="mainApp" class="hidden space-y-6">
            <!-- 接続ステータス表示 -->
            <div class="p-4 bg-gray-50 border border-gray-200 rounded-xl">
                <p id="connectionStatus" class="text-center font-medium">
                    接続していません
                </p>
            </div>

            <!-- ファイル入力セクション (ホストのみ) -->
            <div id="fileInputSection" class="hidden">
                <label for="fileInput" class="file-input-label">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                    <span>音楽ファイルをドラッグ＆ドロップまたはクリックで選択</span>
                </label>
                <input type="file" id="fileInput" accept="audio/*" class="hidden">
            </div>

            <!-- ファイル情報と再生コンポーネント -->
            <div id="fileInfo" class="hidden p-4 bg-indigo-50 border border-indigo-200 rounded-xl space-y-2">
                <p class="font-semibold text-indigo-700">選択したファイル:</p>
                <p id="fileName" class="text-gray-800 break-words"></p>
            </div>
            
            <audio id="audioPlayer" class="w-full hidden rounded-lg"></audio>
            <div id="clientPlaybackStatus" class="hidden text-center text-gray-600 font-medium">
                ホストが再生を開始するのを待っています...
            </div>
            
            <!-- ホスト再生コントロール -->
            <div id="hostPlaybackControls" class="hidden flex justify-center space-x-4">
                <button id="playButton" disabled class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-200 ease-in-out disabled:bg-gray-400 disabled:cursor-not-allowed">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                </button>
                <button id="pauseButton" disabled class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-200 ease-in-out disabled:bg-gray-400 disabled:cursor-not-allowed">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                </button>
            </div>

            <!-- 操作ボタン -->
            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mt-6">
                <button id="disconnectButton" disabled class="flex-1 w-full sm:w-auto px-6 py-3 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition duration-200 ease-in-out disabled:bg-gray-400 disabled:cursor-not-allowed">
                    接続を切断
                </button>
            </div>

            <!-- ホストセクション -->
            <div id="hostSection" class="hidden space-y-4">
                <div class="p-4 bg-gray-50 rounded-lg">
                    <p class="text-sm font-medium text-center text-gray-500 mb-2">
                        参加者に見せてスキャンしてもらってください:
                    </p>
                    <div id="qrCodeHost" class="p-2 border border-gray-300 rounded-lg"></div>
                    <div class="mt-4 flex items-center space-x-2">
                        <input id="hostCode" type="text" readonly class="flex-1 p-2 rounded-lg border border-gray-300 text-sm bg-gray-100" />
                        <button id="copyHostCodeButton" class="bg-indigo-500 text-white p-2 rounded-lg text-sm hover:bg-indigo-600 transition">コピー</button>
                    </div>
                </div>
                
                <div class="p-4 bg-gray-50 rounded-lg">
                    <p class="text-sm font-medium text-center text-gray-500 mb-2">
                        参加者のQRコードをスキャンして接続:
                    </p>
                    <div class="mt-2 text-center">
                        <label for="cameraSelectHost" class="text-sm font-medium text-gray-700">使用するカメラを選択:</label>
                        <select id="cameraSelectHost" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></select>
                        <button id="scanButtonHost" class="w-full mt-2 px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition">
                            スキャンして接続
                        </button>
                        <!-- スキャナーのコンテナ -->
                        <div id="qr-reader-host" class="hidden mt-4"></div>
                    </div>
                </div>
                
                <div class="p-4 bg-gray-50 rounded-lg">
                    <p class="text-sm font-medium text-center text-gray-500 mb-2">
                        または、参加者のコードを貼り付けて接続:
                    </p>
                    <textarea id="pasteClientCode" class="w-full h-24 p-2 rounded-lg border border-gray-300 text-sm focus:outline-none focus:ring focus:ring-indigo-200 focus:border-indigo-300"></textarea>
                    <button id="connectWithClientCodeButton" class="w-full mt-2 px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition">
                        コードで接続
                    </button>
                </div>
            </div>

            <!-- 参加者セクション -->
            <div id="clientSection" class="hidden space-y-4">
                <div class="p-4 bg-gray-50 rounded-lg">
                    <p class="text-sm font-medium text-center text-gray-500 mb-2">
                        ホストのQRコードをスキャンしてください:
                    </p>
                    <div class="mt-2 text-center">
                        <label for="cameraSelectClient" class="text-sm font-medium text-gray-700">使用するカメラを選択:</label>
                        <select id="cameraSelectClient" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></select>
                        <button id="scanButtonClient" class="w-full mt-2 px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition">
                            スキャンして回答を生成
                        </button>
                        <!-- スキャナーのコンテナ -->
                        <div id="qr-reader-client" class="hidden mt-4"></div>
                    </div>
                </div>

                <div class="p-4 bg-gray-50 rounded-lg">
                    <p class="text-sm font-medium text-center text-gray-500 mb-2">
                        または、ホストのコードを貼り付けて回答を生成:
                    </p>
                    <textarea id="pasteHostCode" class="w-full h-24 p-2 rounded-lg border border-gray-300 text-sm focus:outline-none focus:ring focus:ring-indigo-200 focus:border-indigo-300"></textarea>
                    <button id="createAnswerWithHostCodeButton" class="w-full mt-2 px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition">
                        コードで回答を生成
                    </button>
                </div>

                <div id="qrCodeClientSection" class="p-4 bg-gray-50 rounded-lg hidden">
                    <p class="text-sm font-medium text-center text-gray-500 mb-2" id="qrClientTitle">
                        生成されたQRコードをホストに見せてください:
                    </p>
                    <div id="qrCodeClient" class="p-2 border border-gray-300 rounded-lg"></div>
                    <div class="mt-4 flex items-center space-x-2">
                        <input id="clientCode" type="text" readonly class="flex-1 p-2 rounded-lg border border-gray-300 text-sm bg-gray-100" />
                        <button id="copyClientCodeButton" class="bg-indigo-500 text-white p-2 rounded-lg text-sm hover:bg-indigo-600 transition">コピー</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- メッセージ用モーダル -->
        <div id="messageModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-sm">
                <h3 id="modalTitle" class="text-xl font-semibold mb-4 text-center"></h3>
                <p id="modalMessage" class="text-gray-700 text-center mb-6"></p>
                <button id="modalCloseButton" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">閉じる</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // UI要素の取得
            const roleSelection = document.getElementById('roleSelection');
            const mainApp = document.getElementById('mainApp');
            const startHostButton = document.getElementById('startHostButton');
            const startClientButton = document.getElementById('startClientButton');
            
            const fileInput = document.getElementById('fileInput');
            const fileInputSection = document.getElementById('fileInputSection');
            const fileInfoDiv = document.getElementById('fileInfo');
            const fileNameSpan = document.getElementById('fileName');
            const audioPlayer = document.getElementById('audioPlayer');
            const clientPlaybackStatus = document.getElementById('clientPlaybackStatus');
            const connectionStatus = document.getElementById('connectionStatus');
            const disconnectButton = document.getElementById('disconnectButton');
            
            const hostSection = document.getElementById('hostSection');
            const qrCodeHost = document.getElementById('qrCodeHost');
            const scanButtonHost = document.getElementById('scanButtonHost');
            const cameraSelectHost = document.getElementById('cameraSelectHost');
            const qrReaderHostDiv = document.getElementById('qr-reader-host');
            const hostPlaybackControls = document.getElementById('hostPlaybackControls');
            const playButton = document.getElementById('playButton');
            const pauseButton = document.getElementById('pauseButton');
            const hostCodeInput = document.getElementById('hostCode');
            const copyHostCodeButton = document.getElementById('copyHostCodeButton');
            const pasteClientCodeTextarea = document.getElementById('pasteClientCode');
            const connectWithClientCodeButton = document.getElementById('connectWithClientCodeButton');
            
            const clientSection = document.getElementById('clientSection');
            const scanButtonClient = document.getElementById('scanButtonClient');
            const cameraSelectClient = document.getElementById('cameraSelectClient');
            const qrReaderClientDiv = document.getElementById('qr-reader-client');
            const qrCodeClient = document.getElementById('qrCodeClient');
            const qrCodeClientSection = document.getElementById('qrCodeClientSection');
            const qrClientTitle = document.getElementById('qrClientTitle');
            const pasteHostCodeTextarea = document.getElementById('pasteHostCode');
            const createAnswerWithHostCodeButton = document.getElementById('createAnswerWithHostCodeButton');
            const clientCodeInput = document.getElementById('clientCode');
            const copyClientCodeButton = document.getElementById('copyClientCodeButton');

            const messageModal = document.getElementById('messageModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const modalCloseButton = document.getElementById('modalCloseButton');

            // WebRTC ICEサーバー設定
            const iceServers = {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                ]
            };

            // アプリケーションの状態変数
            let peerConnection = null;
            let dataChannel = null;
            let fileData = null;
            let fileMimeType = null;
            let isHost = false;
            let isConnected = false;
            let hostScanner = null;
            let clientScanner = null;
            let offerSdp = null;

            /**
             * カスタムモーダルを表示する関数
             * @param {string} title モーダルのタイトル
             * @param {string} message モーダルのメッセージ
             */
            function showModal(title, message) {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                messageModal.classList.remove('hidden');
            }

            modalCloseButton.onclick = () => {
                messageModal.classList.add('hidden');
            };
            
            /**
             * 利用可能なカメラデバイスを取得し、セレクトボックスに表示する
             */
            async function getDevicesAndPopulateSelectors() {
                try {
                    const devices = await Html5Qrcode.getCameras();
                    if (devices && devices.length > 0) {
                        devices.forEach(device => {
                            const optionHost = document.createElement('option');
                            optionHost.value = device.id;
                            optionHost.textContent = device.label || `Camera ${cameraSelectHost.length + 1}`;
                            cameraSelectHost.appendChild(optionHost);

                            const optionClient = document.createElement('option');
                            optionClient.value = device.id;
                            optionClient.textContent = device.label || `Camera ${cameraSelectClient.length + 1}`;
                            cameraSelectClient.appendChild(optionClient);
                        });
                    } else {
                        showModal('エラー', 'カメラが見つかりませんでした。');
                    }
                } catch (e) {
                    showModal('エラー', 'カメラへのアクセス権限がありません。');
                    console.error('getCameras() error:', e);
                }
            }

            /**
             * QRコードスキャナーを停止する
             * @param {object} scanner 停止するスキャナーインスタンス
             */
            function stopScanner(scanner) {
                if (scanner && scanner.getState() === 2) { // Html5QrcodeScannerState.SCANNING
                    scanner.stop().catch(err => {
                        console.error("Failed to stop scanner:", err);
                    });
                }
            }

            /**
             * WebRTC PeerConnectionを初期化する
             */
            function createPeerConnection() {
                peerConnection = new RTCPeerConnection(iceServers);
                
                // ICE候補が生成されたときのイベント
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        // シンプルにするため、ギャザリング完了後にまとめて処理
                    }
                };
                
                // ICEギャザリングが完了したときのイベント
                peerConnection.onicegatheringstatechange = () => {
                    if (peerConnection.iceGatheringState === 'complete') {
                        console.log('ICE gathering complete');
                        if (isHost) {
                            offerSdp = JSON.stringify(peerConnection.localDescription);
                            const qr = qrcode(0, 'L');
                            qr.addData(offerSdp);
                            qr.make();
                            qrCodeHost.innerHTML = qr.createImgTag(5);
                            hostCodeInput.value = offerSdp;
                            showModal('接続情報生成完了', 'ホストの接続情報が生成されました。参加者にQRコードを見せるか、コードを共有してください。');
                            stopScanner(hostScanner);
                        } else {
                            const answerSDP = JSON.stringify(peerConnection.localDescription);
                            const qr = qrcode(0, 'L');
                            qr.addData(answerSDP);
                            qr.make();
                            qrCodeClient.innerHTML = qr.createImgTag(5);
                            clientCodeInput.value = answerSDP;
                            qrCodeClientSection.classList.remove('hidden');
                            showModal('回答情報生成完了', '回答情報が生成されました。ホストにQRコードを見せるか、コードを共有してください。');
                            stopScanner(clientScanner);
                        }
                    }
                };

                // 接続状態が変化したときのイベント
                peerConnection.onconnectionstatechange = () => {
                    if (peerConnection.connectionState === 'connected') {
                        isConnected = true;
                        connectionStatus.textContent = '接続済み';
                        disconnectButton.disabled = false;
                        if(isHost) {
                            playButton.disabled = false;
                            pauseButton.disabled = false;
                            showModal('接続成功', '参加者と接続しました。音楽を再生してください。');
                            hostSection.classList.add('hidden');
                        } else {
                            showModal('接続成功', 'ホストと接続しました。ホストからの音楽ファイルの受信を待機します。');
                            clientSection.classList.add('hidden');
                        }
                    } else {
                        isConnected = false;
                        connectionStatus.textContent = '切断済み';
                        disconnectButton.disabled = true;
                        playButton.disabled = true;
                        pauseButton.disabled = true;
                    }
                };
                
                // ICE接続状態が変化したときのイベント
                peerConnection.oniceconnectionstatechange = () => {
                    if (peerConnection.iceConnectionState === 'failed' || peerConnection.iceConnectionState === 'disconnected') {
                        connectionStatus.textContent = '接続が切断されました';
                        disconnectButton.disabled = true;
                        if(isHost) {
                            showModal('接続切断', '参加者との接続が切断されました。');
                        } else {
                            showModal('接続切断', 'ホストとの接続が切断されました。');
                        }
                    }
                };
            }

            // ホストとして始めるボタン
            startHostButton.addEventListener('click', async () => {
                isHost = true;
                roleSelection.classList.add('hidden');
                mainApp.classList.remove('hidden');
                fileInputSection.classList.remove('hidden');
                hostSection.classList.remove('hidden');
                connectionStatus.textContent = '待機中...';
                
                createPeerConnection();

                // ホスト側でデータチャネルを作成
                dataChannel = peerConnection.createDataChannel('audio-sync');
                dataChannel.onopen = () => { console.log('Data Channel is open!'); };
                dataChannel.onmessage = async (event) => {
                    const message = JSON.parse(event.data);
                    // 参加者からファイル転送リクエストを受信した場合
                    if (message.type === 'requestAudio') {
                        if (fileData) {
                            showModal('ファイル送信中', '参加者に音楽ファイルを送信しています。');
                            // メッセージサイズの上限を避けるためにデータをチャンクに分割
                            const chunkSize = 16 * 1024; // 16KB
                            const base64Data = fileData.split(',')[1];
                            for (let i = 0; i < base64Data.length; i += chunkSize) {
                                dataChannel.send(JSON.stringify({
                                    type: 'audio_chunk',
                                    mimeType: fileMimeType,
                                    chunk: base64Data.slice(i, i + chunkSize),
                                    isLast: (i + chunkSize) >= base64Data.length
                                }));
                            }
                        } else {
                            showModal('エラー', 'ホストはまだ音楽ファイルを選択していません。');
                        }
                    }
                };
                dataChannel.onclose = () => { console.log('Data Channel is closed.'); };
                
                // オファーを作成してローカルディスクリプションに設定
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
            });

            // 参加者として参加ボタン
            startClientButton.addEventListener('click', () => {
                isHost = false;
                roleSelection.classList.add('hidden');
                mainApp.classList.remove('hidden');
                clientSection.classList.remove('hidden');
                connectionStatus.textContent = '待機中...';
                
                createPeerConnection();

                // 参加者側でデータチャネルを受信
                peerConnection.ondatachannel = (event) => {
                    dataChannel = event.channel;
                    let receivedChunks = [];
                    dataChannel.onopen = () => {
                        console.log('Data Channel is open!');
                        // クライアント側からファイルの転送をリクエスト
                        if(isConnected) {
                             dataChannel.send(JSON.stringify({ type: 'requestAudio' }));
                        }
                    };
                    dataChannel.onmessage = async (event) => {
                        const message = JSON.parse(event.data);
                        if (message.type === 'audio_chunk') {
                            receivedChunks.push(message.chunk);
                            if (message.isLast) {
                                const base64Data = receivedChunks.join('');
                                const mimeType = message.mimeType;
                                fileData = `data:${mimeType};base64,${base64Data}`;
                                audioPlayer.src = fileData;
                                audioPlayer.classList.remove('hidden');
                                fileInfoDiv.classList.remove('hidden');
                                fileNameSpan.textContent = '受信したファイル';
                                clientPlaybackStatus.classList.remove('hidden');
                                showModal('ファイル受信', 'ホストから音楽ファイルを受信しました。');
                                receivedChunks = [];
                            }
                        } else if (message.type === 'sync') {
                            // 参加者はホストのコマンドをリッスン
                            if (message.action === 'play') {
                                audioPlayer.currentTime = message.time;
                                audioPlayer.play();
                                clientPlaybackStatus.textContent = '再生中';
                            } else if (message.action === 'pause') {
                                audioPlayer.currentTime = message.time;
                                audioPlayer.pause();
                                clientPlaybackStatus.textContent = '一時停止中';
                            }
                        }
                    };
                    dataChannel.onclose = () => {
                        console.log('Data Channel is closed.');
                        showModal('接続切断', 'ホストとの接続が切断されました。');
                    };
                };
            });
            
            // ホストの再生・一時停止ボタンのイベントリスナーを設定
            playButton.addEventListener('click', () => {
                if (isConnected && dataChannel && dataChannel.readyState === 'open') {
                    audioPlayer.play();
                    const time = audioPlayer.currentTime;
                    dataChannel.send(JSON.stringify({ type: 'sync', action: 'play', time: time }));
                }
            });

            pauseButton.addEventListener('click', () => {
                if (isConnected && dataChannel && dataChannel.readyState === 'open') {
                    audioPlayer.pause();
                    const time = audioPlayer.currentTime;
                    dataChannel.send(JSON.stringify({ type: 'sync', action: 'pause', time: time }));
                }
            });
            
            // ファイル入力イベント
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        fileData = event.target.result;
                        fileMimeType = file.type;
                        fileInfoDiv.classList.remove('hidden');
                        fileNameSpan.textContent = file.name;
                        audioPlayer.src = URL.createObjectURL(file);
                        audioPlayer.classList.remove('hidden');
                        hostPlaybackControls.classList.remove('hidden');
                        playButton.disabled = false;
                        pauseButton.disabled = false;
                    };
                    reader.readAsDataURL(file);
                }
            });

            // 切断ボタン
            disconnectButton.addEventListener('click', () => {
                if (peerConnection) {
                    peerConnection.close();
                }
                stopScanner(hostScanner);
                stopScanner(clientScanner);
                window.location.reload();
            });

            // ホスト側のQRコードスキャンボタン
            scanButtonHost.addEventListener('click', async () => {
                qrReaderHostDiv.classList.remove('hidden');
                const selectedCameraId = cameraSelectHost.value;
                hostScanner = new Html5Qrcode('qr-reader-host');
                hostScanner.start(
                    selectedCameraId,
                    {
                        fps: 10,
                        qrbox: { width: 250, height: 250 }
                    },
                    (decodedText, decodedResult) => {
                        // 成功コールバック
                        hostScanner.stop().then(() => {
                            try {
                                const remoteAnswer = JSON.parse(decodedText);
                                peerConnection.setRemoteDescription(new RTCSessionDescription(remoteAnswer));
                                showModal('接続完了', '参加者との接続が確立されました！');
                            } catch (e) {
                                showModal('エラー', '無効なQRコードです。');
                                console.error('Failed to set remote answer:', e);
                            }
                        }).catch(err => {
                            console.error("Failed to stop scanner after success:", err);
                        });
                    },
                    (errorMessage) => {
                        // エラーコールバック（リアルタイムでQRが見つからない場合）
                    }
                ).catch(err => {
                    showModal('エラー', 'カメラの起動に失敗しました。アクセスを許可してください。');
                    console.error("Camera start failed:", err);
                });
            });

            // 参加者側のQRコードスキャンボタン
            scanButtonClient.addEventListener('click', async () => {
                qrReaderClientDiv.classList.remove('hidden');
                const selectedCameraId = cameraSelectClient.value;
                clientScanner = new Html5Qrcode('qr-reader-client');
                clientScanner.start(
                    selectedCameraId,
                    {
                        fps: 10,
                        qrbox: { width: 250, height: 250 }
                    },
                    (decodedText, decodedResult) => {
                        // 成功コールバック
                        clientScanner.stop().then(async () => {
                            try {
                                const remoteOffer = JSON.parse(decodedText);
                                await peerConnection.setRemoteDescription(new RTCSessionDescription(remoteOffer));
                                
                                const answer = await peerConnection.createAnswer();
                                await peerConnection.setLocalDescription(answer);
                                
                                showModal('回答情報生成完了', '回答情報が生成されました。ホストにQRコードを見せるか、コードを共有してください。');
                            } catch (e) {
                                showModal('エラー', '無効なQRコードです。');
                                console.error('Failed to set remote offer:', e);
                            }
                        }).catch(err => {
                            console.error("Failed to stop scanner after success:", err);
                        });
                    },
                    (errorMessage) => {
                        // エラーコールバック
                    }
                ).catch(err => {
                    showModal('エラー', 'カメラの起動に失敗しました。アクセスを許可してください。');
                    console.error("Camera start failed:", err);
                });
            });

            // ホスト側のコードコピーボタン
            copyHostCodeButton.addEventListener('click', () => {
                hostCodeInput.select();
                document.execCommand('copy');
                showModal('コピー完了', 'ホストの接続コードをクリップボードにコピーしました。');
            });

            // 参加者側のコード貼り付けボタン
            connectWithClientCodeButton.addEventListener('click', () => {
                const remoteAnswerCode = pasteClientCodeTextarea.value;
                if (remoteAnswerCode) {
                    try {
                        const remoteAnswer = JSON.parse(remoteAnswerCode);
                        peerConnection.setRemoteDescription(new RTCSessionDescription(remoteAnswer));
                        showModal('接続完了', '参加者との接続が確立されました！');
                    } catch (e) {
                        showModal('エラー', '無効な接続コードです。');
                        console.error('Failed to set remote answer from code:', e);
                    }
                } else {
                    showModal('エラー', '接続コードを貼り付けてください。');
                }
            });

            // 参加者側のコードコピーボタン
            copyClientCodeButton.addEventListener('click', () => {
                clientCodeInput.select();
                document.execCommand('copy');
                showModal('コピー完了', '回答コードをクリップボードにコピーしました。');
            });

            // ホスト側のコード貼り付けボタン
            createAnswerWithHostCodeButton.addEventListener('click', async () => {
                const remoteOfferCode = pasteHostCodeTextarea.value;
                if (remoteOfferCode) {
                    try {
                        const remoteOffer = JSON.parse(remoteOfferCode);
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(remoteOffer));
                        
                        const answer = await peerConnection.createAnswer();
                        await peerConnection.setLocalDescription(answer);
                        
                        showModal('回答情報生成完了', '回答情報が生成されました。ホストにQRコードを見せるか、コードを共有してください。');
                    } catch (e) {
                        showModal('エラー', '無効な接続コードです。');
                        console.error('Failed to set remote offer from code:', e);
                    }
                } else {
                    showModal('エラー', 'ホストのコードを貼り付けてください。');
                }
            });

            // ページ読み込み時にカメラデバイスを列挙
            getDevicesAndPopulateSelectors();
        });
    </script>
</body>
</html>
